<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.student.mapper.BizActivityMapper">

    <resultMap type="BizActivity" id="BizActivityResult">
        <result property="id"    column="id"    />
        <result property="title"    column="title"    />
        <result property="description"    column="description"    />
        <result property="coverImg"    column="cover_img"    />
        <result property="startTime"    column="start_time"    />
        <result property="endTime"    column="end_time"    />
        <result property="location"    column="location"    />
        <result property="maxParticipants"    column="max_participants"    />
        <result property="currentParticipants"    column="current_participants"    />
        <result property="pointsReward"    column="points_reward"    />
        <result property="status"    column="status"    />
        <result property="organizerId"    column="organizer_id"    />
        <result property="createdAt"    column="created_at"    />
    </resultMap>

    <sql id="selectBizActivityVo">
        select id, title, description, cover_img, start_time, end_time, location, max_participants, current_participants, points_reward, status, organizer_id, created_at from biz_activity
    </sql>

    <select id="selectBizActivityList" parameterType="BizActivity" resultMap="BizActivityResult">
        <include refid="selectBizActivityVo"/>
        <where>
            <if test="id != null "> and id = #{id}</if>
            <if test="title != null  and title != ''"> and title = #{title}</if>
            <if test="description != null  and description != ''"> and description = #{description}</if>
            <if test="coverImg != null  and coverImg != ''"> and cover_img = #{coverImg}</if>
            <if test="startTime != null "> and start_time = #{startTime}</if>
            <if test="endTime != null "> and end_time = #{endTime}</if>
            <if test="location != null  and location != ''"> and location = #{location}</if>
            <if test="maxParticipants != null "> and max_participants = #{maxParticipants}</if>
            <if test="currentParticipants != null "> and current_participants = #{currentParticipants}</if>
            <if test="pointsReward != null "> and points_reward = #{pointsReward}</if>
            <if test="status != null "> and status = #{status}</if>
            <if test="organizerId != null "> and organizer_id = #{organizerId}</if>
            <if test="createdAt != null "> and created_at = #{createdAt}</if>
        </where>
    </select>

    <select id="selectBizActivityById" parameterType="Long" resultMap="BizActivityResult">
        <include refid="selectBizActivityVo"/>
        where id = #{id}
    </select>
    <update id="updateCurrentParticipants">
        UPDATE biz_activity
        SET current_participants = current_participants + 1
        WHERE id = #{id}
    </update>
    <!-- 取消报名时 -1（安全） -->
    <update id="decrementCurrentParticipants">
        UPDATE biz_activity
        SET current_participants =
                CASE
                    WHEN current_participants > 0 THEN current_participants - 1
                    ELSE 0
                    END
        WHERE id = #{activityId}
    </update>


    <insert id="insertBizActivity" parameterType="BizActivity" useGeneratedKeys="true" keyProperty="id">
        insert into biz_activity
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="title != null and title != ''">title,</if>
            <if test="description != null">description,</if>
            <if test="coverImg != null">cover_img,</if>
            <if test="startTime != null">start_time,</if>
            <if test="endTime != null">end_time,</if>
            <if test="location != null">location,</if>
            <if test="maxParticipants != null">max_participants,</if>
            <if test="currentParticipants != null">current_participants,</if>
            <if test="pointsReward != null">points_reward,</if>
            <if test="status != null">status,</if>
            <if test="organizerId != null">organizer_id,</if>
            <if test="createdAt != null">created_at,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="title != null and title != ''">#{title},</if>
            <if test="description != null">#{description},</if>
            <if test="coverImg != null">#{coverImg},</if>
            <if test="startTime != null">#{startTime},</if>
            <if test="endTime != null">#{endTime},</if>
            <if test="location != null">#{location},</if>
            <if test="maxParticipants != null">#{maxParticipants},</if>
            <if test="currentParticipants != null">#{currentParticipants},</if>
            <if test="pointsReward != null">#{pointsReward},</if>
            <if test="status != null">#{status},</if>
            <if test="organizerId != null">#{organizerId},</if>
            <if test="createdAt != null">#{createdAt},</if>
         </trim>
    </insert>

    <update id="updateBizActivity" parameterType="BizActivity">
        update biz_activity
        <trim prefix="SET" suffixOverrides=",">
            <if test="title != null and title != ''">title = #{title},</if>
            <if test="description != null">description = #{description},</if>
            <if test="coverImg != null">cover_img = #{coverImg},</if>
            <if test="startTime != null">start_time = #{startTime},</if>
            <if test="endTime != null">end_time = #{endTime},</if>
            <if test="location != null">location = #{location},</if>
            <if test="maxParticipants != null">max_participants = #{maxParticipants},</if>
            <if test="currentParticipants != null">current_participants = #{currentParticipants},</if>
            <if test="pointsReward != null">points_reward = #{pointsReward},</if>
            <if test="status != null">status = #{status},</if>
            <if test="organizerId != null">organizer_id = #{organizerId},</if>
            <if test="createdAt != null">created_at = #{createdAt},</if>
        </trim>
        where id = #{id}
    </update>
    <update id="updateBatchStatus">
        UPDATE biz_activity
        SET status = #{status}
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <update id="hideActivities">
        UPDATE biz_activity
        SET status = 3  <!-- 固定为下架状态 -->
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <delete id="deleteBizActivityById" parameterType="Long">
        delete from biz_activity where id = #{id}
    </delete>

    <delete id="deleteBizActivityByIds" parameterType="String">
        delete from biz_activity where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
</mapper>
