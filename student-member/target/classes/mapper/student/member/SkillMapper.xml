<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.student.member.mapper.SkillMapper">

    <resultMap id="SkillResultMap" type="com.ruoyi.student.member.domain.Skill">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="coverImg" column="cover_img"/>
        <result property="categoryId" column="category_id"/>
        <result property="customCategory" column="custom_category"/>
        <result property="pointsPerHour" column="points_per_hour"/>
        <result property="availableTime" column="available_time"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="method" column="method"/>
    </resultMap>
    <update id="updateSkill" parameterType="com.ruoyi.student.member.domain.Skill">
        UPDATE biz_skill_service
        <set>
            <if test="title != null and title != ''">
                title = #{title},
            </if>
            <if test="description != null and description != ''">
                description = #{description},
            </if>
            <if test="coverImg != null and coverImg != ''">
                cover_img = #{coverImg},
            </if>
            <if test="availableTime != null and availableTime != ''">
                available_time = #{availableTime},
            </if>
            <if test="method != null">
                method = #{method},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
        </set>
        WHERE id = #{id} AND user_id = #{userId}
    </update>
    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE FROM biz_skill_service
        WHERE id = #{id}
    </delete>

    <select id="selectCategories" resultType="com.ruoyi.student.member.domain.SkillCategory">
        SELECT
            c.id,
            c.name,
            COALESCE(r.point_value, 0) AS pointsPerHour
        FROM
            biz_skill_category c
                LEFT JOIN
            biz_point_rule r
            ON c.id = r.category_id
                AND r.role_type = 1
                AND r.is_active = TRUE
        WHERE
            c.is_active = TRUE
        ORDER BY
            c.sort DESC, c.id ASC
    </select>

    <!-- 根据分类ID查询分类详情（含积分规则） -->
    <select id="selectCategoryById" parameterType="Long" resultType="com.ruoyi.student.member.domain.SkillCategory">
        SELECT
        c.id,
        c.name,
        c.is_active AS active,
        COALESCE(r.point_value, 0) AS pointsPerHour
        FROM biz_skill_category c
        LEFT JOIN biz_point_rule r
        ON c.id = r.category_id
        AND r.role_type = 1     <!-- 假设 1=学生提供者，按你实际业务调整 -->
        AND r.is_active = TRUE
        WHERE c.id = #{id}
    </select>
    <select id="selectSkillList" resultMap="SkillResultMap">
        SELECT
        id, user_id, title, description, cover_img,
        category_id, custom_category, available_time,
        points_per_hour, status, created_at,
        method
        FROM biz_skill_service
        <where>
            <if test="userId != null">AND user_id = #{userId}</if>
        </where>
    </select>

    <select id="selectByStatus" resultMap="SkillResultMap">
        SELECT
            id, user_id, title, description, cover_img,
            category_id, custom_category, available_time,
            points_per_hour, status, created_at,
            method
        FROM biz_skill_service
        WHERE status = #{status}
    </select>
    <select id="selectById" parameterType="Long" resultMap="SkillResultMap">
        SELECT * FROM biz_skill_service WHERE id = #{id}
    </select>


    <insert id="insertSkill" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO biz_skill_service (
            user_id, title, cover_img, description,
            category_id, custom_category, points_per_hour,
            available_time, method, status, created_at
        ) VALUES (
                     #{userId}, #{title}, #{coverImg}, #{description},
                     #{categoryId}, #{customCategory}, #{pointsPerHour},
                     #{availableTime}, #{method}, 0, #{createdAt}
                 )
    </insert>
    <select id="selectPublicSkillsWithKeyword" resultMap="SkillResultMap">
        SELECT
        id, user_id, title, description, cover_img,
        category_id, custom_category, available_time,
        points_per_hour, status, created_at,
        method
        FROM biz_skill_service
        WHERE status = 1
        <if test="keyword != null and keyword != ''">
            <choose>
                <!-- 注意：method=0 是“线上”，method=1 是“线下” -->
                <when test="keyword == '线上'">
                    AND method = 0
                </when>
                <when test="keyword == '线下'">
                    AND method = 1
                </when>
                <otherwise>
                    AND title LIKE CONCAT('%', #{keyword}, '%')
                </otherwise>
            </choose>
        </if>
        ORDER BY created_at DESC
    </select>
</mapper>
