<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.student.member.mapper.EnrollmentMapper">

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO biz_user_enrollment (user_id, activity_id, status, enrolled_at)
        VALUES (#{userId}, #{activityId}, #{status}, NOW())
    </insert>

    <select id="existsByUserIdAndActivityId" resultType="boolean">
        SELECT EXISTS(
            SELECT 1 FROM biz_user_enrollment
            WHERE user_id = #{userId} AND activity_id = #{activityId}
        )
    </select>
    <select id="selectByUserId" resultType="com.ruoyi.student.member.domain.Enrollment">
        SELECT
            id,
            user_id AS userId,
            activity_id AS activityId,
            status,
            enrolled_at AS enrolledAt,
            completed_at AS completedAt
        FROM biz_user_enrollment
        WHERE user_id = #{userId}
        ORDER BY enrolled_at DESC
    </select>

    <select id="selectCompletedByUserId" resultType="com.ruoyi.student.member.domain.Enrollment">
        SELECT id, user_id AS userId, activity_id AS activityId, completed_at AS completedAt
        FROM biz_user_enrollment
        WHERE user_id = #{userId} AND completed_at IS NOT NULL
        ORDER BY completed_at DESC
    </select>
    <!-- 查询报名记录 -->
    <select id="selectById" resultType="com.ruoyi.student.member.domain.Enrollment">
        SELECT
            id,
            user_id AS userId,
            activity_id AS activityId,
            status,
            enrolled_at AS enrolledAt,
            completed_at AS completedAt
        FROM biz_user_enrollment
        WHERE id = #{id}
    </select>
    <resultMap id="PointResultMap" type="java.lang.Integer">
        <result property="value" column="points_reward"/>
    </resultMap>

    <select id="selectPointsRewardByActivityId" resultMap="PointResultMap">
        SELECT points_reward FROM biz_activity WHERE id = #{activityId}
    </select>

    <!-- 更新报名记录-->
    <update id="updateById">
        UPDATE biz_user_enrollment
        <set>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="activityId != null">activity_id = #{activityId},</if>
            <if test="status != null">status = #{status},</if>
            <if test="enrolledAt != null">enrolled_at = #{enrolledAt},</if>
            <if test="completedAt != null">completed_at = #{completedAt}</if>
        </set>
        WHERE id = #{id}
    </update>
    <select id="selectByUserIdWithPagination" resultType="com.ruoyi.student.member.domain.Enrollment">
        SELECT
            id,
            user_id AS userId,
            activity_id AS activityId,
            status,
            enrolled_at AS enrolledAt,
            completed_at AS completedAt
        FROM biz_user_enrollment
        WHERE user_id = #{userId}
        ORDER BY enrolled_at DESC
            LIMIT #{offset}, #{limit}
    </select>
    <select id="countByUserId" resultType="int">
        SELECT COUNT(*) FROM biz_user_enrollment WHERE user_id = #{userId}
    </select>
    <!-- 查询用户已完成活动的积分总和 -->
    <select id="selectCompletedActivityPoints" resultType="int">
        SELECT COALESCE(SUM(a.points_reward), 0)
        FROM biz_user_enrollment e
                 INNER JOIN biz_activity a ON e.activity_id = a.id
        WHERE e.user_id = #{userId}
          AND e.completed_at IS NOT NULL
          AND a.points_reward > 0
    </select>
</mapper>
